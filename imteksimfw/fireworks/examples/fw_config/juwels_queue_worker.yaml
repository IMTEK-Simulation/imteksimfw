#!/usr/bin/env python
#
# juwels_queue_worker.yaml
#
# Copyright (C) 2020 IMTEK Simulation
# Author: Johannes Hoermann, johannes.hoermann@imtek.uni-freiburg.de
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
name:     juwels_queue_worker
category: [ 'juwels_queue' ]
query:    '{}'
env:
  lmp: module purge;
        module use /gpfs/software/juwels/otherstages;
        module load Stages/2018b;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load lammps/16Mar18-intel-2019-gcc-7.3-impi-2018-colvars-18Feb19;
        srun lmp
  exchange_substrate.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools ovitos;
        exchange_substrate.py
  extend_ndx_by_per_atom_groups: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/easybuild/otherstages;
        module load Stages/2019a;
        module load Intel/2019.3.199-GCC-8.3.0 IntelMPI/2019.3.199 GromacsWrapper/0.8.0-Python-3.6.8 GROMACS-Top/2019.3 imteksimcs/devel-Python-3.6.8;
        extend_ndx_by_per_atom_groups
  extract_bb.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools/01Jun19-python-2.7;
        extract_bb.py
  extract_indenter_nonindenter_forces_from_netcdf.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        extract_indenter_nonindenter_forces_from_netcdf.py
  extract_property.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools ovitos;
        extract_property.py
  extract_thermo.sh: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        extract_thermo.sh
  gmx: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/easybuild/otherstages;
        module load Stages/2019a Intel/2019.3.199-GCC-8.3.0 IntelMPI/2019.3.199;
        module load GROMACS/2019.3 GROMACS-Top/2019.3;
        srun gmx_mpi
  join_thermo.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        join_thermo.py
  merge.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools/01Jun19-python-2.7;
        merge.py
  ncfilter.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        srun ncfilter.py
  ncjoin.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        ncjoin.py
  ncap2: module purge;
        module load Intel IntelMPI NCO;
        ncap2
  ncks: module purge;
        module load Intel IntelMPI NCO;
        ncks
  ncrename: module purge;
        module load Intel IntelMPI NCO;
        ncrename
  ncpdq: module purge;
        module load Intel IntelMPI NCO;
        ncpdq
  netcdf2data.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools ovitos;
        netcdf2data.py
  packmol: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/easybuild/otherstages;
        module load Stages/2019a Intel/2019.3.199-GCC-8.3.0 packmol/20.010;
        packmol
  pdb_chain: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/easybuild/otherstages;
        module load Stages/2019a GCC/8.3.0 pdb-tools/2.0.1-Python-3.6.8;
        pdb_chain
  pdb_reres: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/easybuild/otherstages;
        module load Stages/2019a GCC/8.3.0 pdb-tools/2.0.1-Python-3.6.8;
        pdb_reres
  pdb_tidy: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/easybuild/otherstages;
        module load Stages/2019a GCC/8.3.0 pdb-tools/2.0.1-Python-3.6.8;
        pdb_tidy
  pizza.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools/01Jun19-python-2.7;
        pizza.py
  strip_comments.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools/01Jun19-python-2.7;
        strip_comments.py
  to_hybrid.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        to_hybrid.py
  vmd: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load jlhvmd;
        vmd
  smbsync.py: module purge;
        jutil env activate -p chfr13;
        module use ${PROJECT}/common/juwels/modulefiles;
        module load mdtools;
        smbsync.py

  python:
    init:
    - 'import sys, os, importlib, builtins'
    - 'builtins.module = importlib.import_module("imteksimfw.utilities.env_modules_python").module'
    - 'module("purge")'
    - 'module("use",os.path.join(os.environ["PROJECT"],"common","juwels","easybuild","otherstages"))'
    - 'module("load","Stages/2019a")'
    - 'module("avail")'
    cmd:
      lmp:
        init:
        - 'module("use","/gpfs/software/juwels/otherstages")'
        - 'module("load","Stages/2018b")'
        - 'module("load","lammps/16Mar18-intel-2019-gcc-7.3-impi-2018-colvars-18Feb19")'
        - 'module("list")'
        prefix: 'srun'

      convert:
        init:
        - 'module("load","GCC","ImageMagick")'
        - 'module("list")'

      exchange_substrate.py:
        init:
        - 'module("load","mdtools","ovitos")'
        - 'module("list")'

      extend_ndx_by_per_atom_groups:
        init:
        - 'module("load","Stages/2019a","Intel/2019.3.199-GCC-8.3.0","IntelMPI/2019.3.199")'
        - 'module("load","GromacsWrapper/0.8.0-Python-3.6.8","GROMACS-Top/2019.3")'
        - 'module("load","imteksimcs/devel-Python-3.6.8")'

      extract_bb.py:
        init:
        - 'module("load","mdtools/01Jun19-python-2.7")'
        - 'module("list")'

      extract_indenter_nonindenter_forces_from_netcdf.py:
        init:
        - 'module("load","mdtools")'
        - 'module("list")'

      extract_property.py:
        init:
        - 'module("load","mdtools","ovitos")'
        - 'module("list")'

      extract_thermo.sh:
        init: 'module("load","mdtools")'

      gmx:
        init:
        - 'module("load","Stages/2019a","Intel/2019.3.199-GCC-8.3.0","IntelMPI/2019.3.199")'
        - 'module("load","GROMACS/2019.3","GROMACS-Top/2019.3")'
        - 'module("list")'
        prefix: srun
        substitute: gmx_mpi

      gmx_tools:
        init:
        - 'module("load","Stages/2019a","Intel/2019.3.199-GCC-8.3.0","IntelMPI/2019.3.199")'
        - 'module("load","GromacsWrapper/0.8.0-Python-3.6.8","GROMACS-Top/2019.3")'
        - 'module("load","imteksimcs/devel-local-Python-3.6.8")'
        - 'module("list")'
        env:
           FI_PROVIDER: tcp

      join_thermo.py:
        init:
        - 'module("load","mdtools")'
        - 'module("list")'

      merge.py:
        init:
        - 'module("load","mdtools/01Jun19-python-2.7")'
        - 'module("list")'

      ncfilter.py:
        init:
        - 'module("load","mdtools")'
        - 'module("list")'
        prefix: 'srun'

      ncjoin.py:
        init:
        - 'module("load","mdtools")'
        - 'module("list")'

      ncap2:
        init:
        - 'module("load","Intel","IntelMPI","NCO")'
        - 'module("list")'

      ncks:
        init:
        - 'module("load","Intel","IntelMPI","NCO")'
        - 'module("list")'

      ncrename:
        init:
        - 'module("load","Intel","IntelMPI","NCO")'
        - 'module("list")'

      ncpdq:
        init:
        - 'module("load","Intel","IntelMPI","NCO")'
        - 'module("list")'

      netcdf2data.py:
        init:
        - 'module("load","mdtools","ovitos")'
        - 'module("list")'

      packmol:
        init:
        - 'module("load","Stages/2019a","Intel/2019.3.199-GCC-8.3.0","packmol/20.010")'
        - 'module("list")'

      pdb_chain:
        init:
        - 'module("load","Stages/2019a","GCC/8.3.0","pdb-tools/2.0.1-Python-3.6.8")'
        - 'module("list")'

      pdb_reres:
        init:
        - 'module("load","Stages/2019a","GCC/8.3.0","pdb-tools/2.0.1-Python-3.6.8")'
        - 'module("list")'

      pdb_tidy:
        init:
        - 'module("load","Stages/2019a","GCC/8.3.0","pdb-tools/2.0.1-Python-3.6.8")'
        - 'module("list")'

      pizza.py:
        init:
        - 'module("load","mdtools/01Jun19-python-2.7")'
        - 'module("list")'

      strip_comments.py:
        init:
        - 'module("load","mdtools/01Jun19-python-2.7")'
        - 'module("list")'

      to_hybrid.py:
        init:
        - 'module("load","mdtools")'
        - 'module("list")'

      vmd:
        init:
        - 'module("load","jlhvmd")'
        - 'module("list")'

      smbsync.py:
        init:
        - 'module("load","mdtools")'
        - 'module("list")'

  imteksimpy:
    init:
    - 'import site, sys, os, importlib, builtins'
    - 'builtins.module = importlib.import_module("imteksimfw.utilities.env_modules_python").module'
    - 'module("purge")'
    - 'module("use",os.path.join(os.environ["PROJECT"],"common","juwels","easybuild","otherstages"))'
    - 'module("load","Stages/2019a","Intel/2019.3.199-GCC-8.3.0","IntelMPI/2019.3.199")'
    - 'module("load","ASE/3.17.0-Python-3.6.8")'
    - 'module("load","imteksimcs/devel-local-Python-3.6.8")'
    - 'module("load","imteksimpyenv/devel-Python-3.6.8")'
    - 'module("list")'
    - 'for d in list(set(os.environ["PYTHONPATH"].split(":")) - set(sys.path)): site.addsitedir(d)'
    # this last line is nasty
